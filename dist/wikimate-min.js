(function(a){a.plugin=function(b,c){a.fn[b]=function(d){if(c[d])return c[d].apply(this,Array.prototype.slice.call(arguments,1));if(typeof d=="object"||!d)return c.init.apply(this,arguments);a.error("Method "+d+" does not exist on jQuery."+b)}},window.wikimate={version:"0.0.1",plugins:{},events:{},utils:function(){function b(a){var b=[];for(var d=1;1<=a?d<=a:d>=a;1<=a?d++:d--)b.push(c());return b.join("")}function c(){return((1+Math.random())*256|0).toString(16).substring(1)}function d(a,b){if(!b)return a;var c;return _.any(a,function(a){return a.id===b?(a.story||(a.story=[]),c=a.story,!0):a.story?(c=d(a.story,b),_.isObject(c)):!1}),c}function e(a,b){return _.find(a,function(a){return a.id===b})}function f(a,b){return a.indexOf(e(a,b))}return{generateId:function(){return b(8)},replay:function(b){var c=[];return _.each(b,function(a){var b=d(c,a.inside);switch(a.type){case"add":var g=wikimate.utils.deepClone(a.item);if(a.after){var h=f(b,a.after);b.splice(h+1,0,g)}else b.push(g);break;case"edit":e(b,a.id).text=a.item.text;break;case"remove":var i=f(b,a.id);b.splice(i,1);break;case"move":b.sort(function(b,c){var d=a.order.indexOf(b.id),e=a.order.indexOf(c.id);return d==e?0:d>e?1:-1});break;default:throw"Unknown event type: "+a.type}}),a.extend(c,{itemStoryByItemId:function(a){return d(this,a)}})},deepClone:function(b){return a.parseJSON(JSON.stringify(b))}}}(),fn:{init:function(a){return this.addClass("wikimate").wikimate("story",a)}}},a.plugin("wikimate",wikimate.fn)})(jQuery),function(a){function b(){if(document.selection&&document.selection.empty)document.selection.empty();else if(window.getSelection){var a=window.getSelection();a.removeAllRanges()}}a.plugin("story",{init:function(b){var c=this;return a.each(b||[],function(b,d){a("<div/>").story_item({data:d}).appendTo(c)}),this.addClass("wikimate-story").story("bindChangeEvents").story("dblclickToNewItem")},execute:function(b){var c;b=wikimate.utils.deepClone(b);if(b.inside){c=a("#"+b.inside);var d=c.find(".wikimate-story:first");return d.story("execute",_.extend(b,{inside:null})),c.story_item("data").story=d.story("data"),this}if(b.type=="add")c=a("<div/>").story_item({data:b.item}),b.after?c.insertAfter(a("#"+b.after)):c.prependTo(this),c.effect("highlight");else if(b.type=="remove")a("#"+b.id).removeClass("item").effect("explode",{},"normal",function(){a(this).remove()});else if(b.type=="edit")a("#"+b.id).story_item("data",b.item).story_item("render").effect("highlight");else if(b.type=="move"){var e=b.order.indexOf(b.id),f=a("#"+b.id);e===0?this.prepend(f):f.insertAfter(a("#"+b.order[e-1])),f.effect("highlight")}return this},data:function(){return a.map(this.find("> .item"),function(b){return a(b).story_item("data")})},newItem:function(b,c){if(c&&c.inside)return a("#"+c.inside+" .wikimate-story:first").story("newItem",b,{after:c.after});var d=a("<div/>").story_item({newItem:!0,data:b});return c&&c.after?d.insertAfter(a("#"+c.after)):d.appendTo(this)},bindChangeEvents:function(){var a=this;return this.sortable({handle:".item-handle",forcePlaceholderSize:!0,placeholder:"sort-placeholder",opacity:.8,update:function(b,c){c.item.story_item("moved",{order:_.pluck(a.find("> .item"),"id")})}})},dblclickToNewItem:function(){var a=this;return this.dblclick(function(c){c.preventDefault(),c.stopPropagation(),c.target==a[0]&&(b(),a.story("newItem").story_item("edit"))})}}),a.extend(wikimate.events,{CHANGE:"wikimate:change"}),window.wikimate.default_story_item_type="paragraph",a.extend(wikimate.fn,{newItem:function(a,b){return this.find("> .wikimate-story").story("newItem",a,b)},story:function(b){if(b){b.change&&this.on(wikimate.events.CHANGE,b.change);var c=a("<div />").story("init",b.story),d=a('<div title="Add new Item">[+]</a>').addClass("add-new-factory").on("click",function(a){return c.story("newItem",{type:"factory"})});return this.append(c).append(d)}return this.find("> .wikimate-story").story("data")}})}(jQuery),function(a){a.plugin("story_item",function(){function b(a){return wikimate.plugins[a.type]||wikimate.plugins.unknown}function c(c){var d=c.story_item("data"),e=a("<div />").addClass("item-content"),g=b(d);return g.emit.apply(c,[e,d]),g.bind.apply(c,[e,d]),f(e),c.html(e)}function d(a){var c=a.story_item("data");return b(c).edit.apply(a,[c])}function e(c){var d=a.extend({id:wikimate.utils.generateId(),type:wikimate.default_story_item_type},c||{}),e=b(d);return d=e.defaultData===undefined?d:_.defaults(d,e.defaultData()),_.defaults(d,{text:""})}var f=function(){function b(b){return a('<a href="javascript:void(0)" title="Click me or double click the content to edit">Edit</a>').on("click",function(a){return b.parent().story_item("edit")})}function c(b){return a('<a href="javascript:void(0)" title="Remove section">Del</a>').on("click",function(a){return b.parent().story_item("remove")})}function e(){var b=a("<div />").addClass("item-handle").extend(d).grab();return b.mousedown(function(a){b.grabing()}).mouseup(function(){b.grab()})}var d={grab:function(){return this.css("cursor","grab").css("cursor","-moz-grab").css("cursor","-webkit-grab")},grabing:function(){return this.css("cursor","grabbing").css("cursor","-moz-grabbing").css("cursor","-webkit-grabbing")}};return function(d){return d.hover(function(f){var g=a("<div />").addClass("item-action-bar").append(c(d)).append(b(d)).append(e());d.append(g)},function(a){d.find(".item-action-bar").remove()})}}(),g;return{init:function(a){var b=e(a.data);return this.data("data",b),this.addClass("item "+b.type).prop("id",b.id).data("newItem",a.newItem).story_item("render")},newItem:function(){return this.data("newItem")},status:function(a){return a?(g=a,_.delay(function(){g=undefined},100),this):g},editable:function(){return g===undefined},edit:function(){return d(this)},data:function(a){return a?this.data("data",a):this.data("data")},render:function(){return c(this.story_item("status","rendering item"))},cancel:function(){return this.story_item("save",this.story_item("data").text)},save:function(a){var b=this.story_item("data");return a===""?this.story_item("remove"):this.data("newItem")||a!=b.text?this.story_item("update",{text:a}):this.story_item("render"),this},remove:function(){this.story_item("status","removing item"),this.data("newItem")?this.remove():(this.removeClass("item"),this.trigger(wikimate.events.CHANGE,{id:this.story_item("data").id,type:"remove",inside:this.parents(".item:first").prop("id")}),this.remove())},update:function(b){this.story_item("status","updating item");var d=a.extend(this.story_item("data"),b);return this.data("newItem")?(c(this.removeData("newItem")),this.trigger(wikimate.events.CHANGE,{id:d.id,type:"add",item:wikimate.utils.deepClone(d),after:this.prev().prop("id"),inside:this.parents(".item:first").prop("id")})):(c(this),this.trigger(wikimate.events.CHANGE,{id:d.id,type:"edit",item:wikimate.utils.deepClone(d),inside:this.parents(".item:first").prop("id")})),this},moved:function(a){return this.story_item("status","moved item"),this.trigger(wikimate.events.CHANGE,{id:this.prop("id"),type:"move",order:a.order,inside:this.parents(".item:first").prop("id")}),this}}}())}(jQuery),function(a){function d(a,b,c){a&&a.apply(b,c)}var b={TAB:9,RETURN:13,ESC:27,s:83},c="click.story_item_editor";a.plugin("editor_shortcuts",{init:function(a){return this.data("options",a).editor_shortcuts("bindShortcuts").editor_shortcuts("bindClickOutsideSave")},save:function(){var b=this.data("options");b&&(a(window).off(c),d(b.save,this,[b.value]),d(b.close,this,["save"]))},cancel:function(){var b=this.data("options");b&&(a(window).off(c),d(b.cancel,this,[b.value]),d(b.close,this,["cancel"]))},editingElement:function(){return this.parent()[0]},bindClickOutsideSave:function(){var b=this;return a(window).on(c,function(c){var d=b.editor_shortcuts("editingElement"),e=a(c.target).closest("html")[0];e&&d&&a(c.target).is(":visible")&&!a.contains(d,c.target)&&b.editor_shortcuts("save")}),this},bindShortcuts:function(){var c=this.data("options");return this.keydown(function(d){if(d.which==b.ESC)d.preventDefault(),d.stopPropagation(),a(this).editor_shortcuts("cancel");else if(d.which==b.RETURN){if(c.ignoreReturn)return;d.preventDefault(),d.stopPropagation(),a(this).editor_shortcuts("save")}else(d.metaKey||d.ctrlKey)&&d.which==b.s&&(d.preventDefault(),d.stopPropagation(),a(this).editor_shortcuts("save"))})}})}(jQuery),function(a){a.plugin("wikimate_inline_editable",{init:function(b){return this.dblclick(function(c){if(a(this).find(".wikimate-inline-editor").length>0)return!1;var d=a('<input type="text"/>').addClass("wikimate-inline-editor").val(a(this).text()).editor_shortcuts({value:a(this).text(),save:function(a){this.parent().text(this.val()),b.saved&&b.saved.apply(this,[this.val()])},cancel:function(a){this.parent().text(a),b.canceled&&b.canceled.apply(this,[a])}}).dblclick(function(a){return!1});b&&b.width&&d.width(b.width),a(this).empty().html(d),d.focus()}),this}})}(jQuery),function(a){a.plugin("sticky",{init:function(){var b=this;return a(window).scroll(function(c){var d=parseInt(a(window).scrollTop(),10),e=b.parent().offset();if(d>=e.top&&b.css("position")!="fixed"){var f=b.offset(),g=f.top-e.top;b.data("origin",f),b.css("position","fixed").css("left",f.left+"px"),b.offset().top<g?b.css("top",g+"px"):b.offset().top>1&&b.css("top",g+"px")}else if(d<e.top){var h=b.data("origin");b.css("position","absolute").css("left","")}}),this}})}(jQuery),jQuery.plugin("wikimate_text_editor",function(a){function d(a){var b=a.prop("scrollHeight");b>a.innerHeight()&&a.height(b+c)}function e(b,c){var d="Click me/outside to save, or Ctrl/Cmd + s to save. ESC to cancel",e=a('<a href="javascript:void(0)">Save</a>').prop("title",d).click(function(a){b.find(".plain-text-editor").editor_shortcuts("save")}),f=a("<div />").addClass("editor-action-bar").append(e);b.append(f).hover(function(a){f.show()},function(a){f.hide()}),c.on("keydown.editor_action_bar",function(){c.off(".editor_action_bar"),f.show()})}var b={RETURN:13},c=16;return{init:function(c){var f=this.story_item("data"),g=this,h=a("<textarea/>").text(f.text).addClass("plain-text-editor").editor_shortcuts(_.extend({save:function(){g.story_item("save",h.val())},cancel:function(){g.story_item("cancel")},close:function(){},ignoreReturn:!0},c)).on("keyup",function(c){d(h);if(c.which==b.RETURN){var e=h.val();e.trim().length>0&&e.substr(-2)=="\n\n"&&(c.preventDefault(),h.val(e.substr(0,e.length-1)),h.editor_shortcuts("save"),a("<div/>").story_item({data:{type:f.type},newItem:!0}).insertAfter(g).story_item("edit"))}}).on("dblclick",function(){return!1}).focus();return this.html(h),e(this,h),d(h),this.wikimate_text_editor("moveCursorTo",f.text.length)},moveCursorTo:function(a){var b=this.find("> .plain-text-editor")[0];return b.selectionStart=a,b.selectionEnd=a,this}}}(jQuery)),function(a){a.plugin("journal",function(){function b(a,b){switch(b.type){case"move":return"Item was moved";case"add":case"remove":case"edit":var c=a.journal("data"),d=wikimate.utils.replay(c.slice(0,c.indexOf(b))),e=d.itemStoryByItemId(b.inside),f=_.find(e,function(a){return a.id===b.id}),g=f?f.text:undefined,h=b.item?b.item.text:undefined;return JsDiff.convertChangesToXML(JsDiff.diffWords(g,h)).replace(/\n/g,"<br/>");default:throw"Unknown action type "+b.type}}function c(c,d){var e=d.type.charAt(0);return a('<a href="javascript:void(0)"/>').data("data",d).addClass("action "+d.type).text(e).hover(function(e){a("#"+d.id).addClass("highlight");var f=b(c,d),g=c.parent().offset(),h=a(this).offset();h.left-=g.left,h.top-=g.top;var i=a("<div/>").addClass("diff").html(f).appendTo(c.parent()).css("left",h.left+a(this).width()*3/4);i.css("top",h.top-i.height())},function(b){a(".wikimate .diff").remove(),a(".wikimate .highlight").removeClass("highlight")})}var d;return{init:function(b,c){var e=this;return d=c,a.each(b||[],function(a,b){e.journal("push",b)}),this},push:function(a){var b=c(this,a);return this.append(b),d&&d(b),this},pop:function(){var a=this.find("> .action:last"),b=a.data("data");return a.remove(),b},data:function(){return a.map(this.find("> .action"),function(b){return a(b).data("data")})}}}()),wikimate.fn.journal=function(b,c){if(b){var d=a("<div />").addClass("wikimate-journal").journal("init",b,c);return this.find("> .wikimate-story").on(wikimate.events.CHANGE,function(a,b){d.journal("push",b)}),this.append(d)}return this.find("> .wikimate-journal").journal("data")}}(jQuery),function(a){function b(a){var b,c;switch(a.type){case"remove":b=wikimate.utils.replay(this.wikimate("journal")),c=b.itemStoryByItemId(a.inside);var d=_.find(c,function(b){return b.id===a.id}),e=c.indexOf(d),f=e===0?null:c[e-1].id;return{id:a.id,type:"add",item:d,after:f,inside:a.inside};case"add":return{id:a.id,type:"remove",item:a.item,inside:a.inside};case"edit":b=wikimate.utils.replay(this.wikimate("journal")),c=b.itemStoryByItemId(a.inside);var g=_.find(c,function(b){return b.id===a.id});return{id:a.id,type:"edit",item:wikimate.utils.deepClone(g),inside:a.inside};case"move":return b=wikimate.utils.replay(this.wikimate("journal")),c=b.itemStoryByItemId(a.inside),{id:a.id,type:"move",order:_.pluck(c,"id"),inside:a.inside};default:throw"Unknown action type: "+a.type}}wikimate.fn.undo=function(){var a=this.find("> .wikimate-journal").journal("pop");if(!a)return;return this.find("> .wikimate-story").story("execute",b.apply(this,[a])),a}}(jQuery),function(a){a.plugin("dropfile",{init:function(a){var b=this;return this.on("drop",function(c){c.stopPropagation(),c.preventDefault();if(!c.originalEvent.dataTransfer)return;var d=c.originalEvent.dataTransfer.files[0];if(!d)return;var e=new XMLHttpRequest;e.open("post",a.post_url,!0),e.setRequestHeader("X-Requested-With","XMLHttpRequest"),a.start.apply(b,[e,d]),e.addEventListener("load",function(c){a.complete.apply(b,[c,d])},!1);var f=new FormData;f.append(a.field_name,d),e.send(f)})}})}(jQuery),function(a){function b(a,b){return a.empty().removeClass("factory").story_item({data:{type:b},newItem:!0})}wikimate.plugins.factory={emit:function(b,c){var d=a("<ul/>");for(var e in wikimate.plugins){var f=wikimate.plugins[e].title;if(f){var g=a('<a href="javascript:void(0)"/>').addClass("new-plugin-item-link new-"+e).text(f).data("plugin",e);a("<li/>").html(g).appendTo(d)}}return this.data("newItem",!0),b.html("Double-Click to Edit or Add:").append(d)},edit:function(){return b(this,wikimate.default_story_item_type).story_item("edit")},bind:function(c,d){var e=this;c.find(".new-plugin-item-link").click(function(c){b(e,a(this).data("plugin")).story_item("edit")}),c.on("dblclick",function(a){e.story_item("editable")&&e.story_item("edit")})}}}(jQuery),function(a){wikimate.plugins.paragraph={emit:function(b,c){var d=a.map(c.text.split("\n"),function(a){return a.length>0?"<p>"+a+"</p>":""}).join("");return b.html(d)},bind:function(a,b){var c=this;a.on("dblclick",function(a){c.story_item("editable")&&c.story_item("edit")})},edit:function(a){return this.wikimate_text_editor("init")}}}(jQuery),function(a){function b(a,b){var c=b.getContent();b.remove(),b.destroy(),a.story_item("save",c)}function c(a,b){b.remove(),b.destroy(),a.story_item("cancel")}wikimate.plugins.rdoc={title:"Rich Document",editor_options:{},emit:function(a,b){return a.html(b.text)},bind:function(a,b){var c=this;a.on("dblclick",function(a){c.story_item("editable")&&c.story_item("edit")})},edit:function(d){var e=this,f=wikimate.utils.generateId(),g=a("<textarea/>").prop("id",f).text(d.text).appendTo(this.empty()).editor_shortcuts({save:function(){b(e,tinymce.activeEditor)},cancel:function(){c(e,tinymce.activeEditor)},close:function(){},ignoreReturn:!0});return tinymce.init(_.extend({mode:"exact",elements:f,theme:"advanced",plugins:"advlink,advimage,advlist,autoresize,autolink,save,table,fullscreen,spellchecker,wordcount,contextmenu,media,lists,inlinepopups",theme_advanced_buttons1:"save,cancel,|,bold,italic,underline,strikethrough,hr,|,justifyleft,justifycenter,justifyright,justifyfull,|,bullist,numlist,|,outdent,indent,|,undo,redo,|,link,unlink,image,code,removeformat",theme_advanced_buttons2:"table,fullscreen,media,formatselect",theme_advanced_buttons3:"",theme_advanced_toolbar_location:"top",theme_advanced_toolbar_align:"left",auto_focus:f,save_onsavecallback:function(a){return b(e,a),!1},save_oncancelcallback:function(a){return c(e,a),!1}},wikimate.plugins.rdoc.editor_options)),this}}}(jQuery),function(a){function c(a){return _.map(_.select(a.text.split("\n"),function(a){return a.trim().length!==0}),function(a){return a[0]==b?{status:a[0],content:a.substring(1)}:{content:a}})}function d(c){var d=a('<input type="checkbox"/>').prop("checked",c.status==b),e=a("<span/>").text(c.content);return a("<li/>").append(d).append(e)}var b="✓";wikimate.plugins.todo={title:"Todo list",defaultData:function(){return{text:"one line one todo item"}},emit:function(a,b){return _.each(c(b),function(b){d(b).appendTo(a)}),this},bind:function(c,d){var e=this;c.find("li input").each(function(d,f){a(f).change(function(d){var f=c.find("li").map(function(c,d){var e=a(d).find("input").prop("checked")?b:"",f=a(d).find("span").text();return e+f}).toArray();return e.story_item("save",f.join("\n")),!0})})},edit:function(a){return this.wikimate_text_editor("init")}}}(jQuery),function(a){wikimate.plugins.image={title:"Image",emit:function(b,c){return b.html(a("<img/>").prop("src",c.text))},bind:function(a,b){var c=this;a.click(function(a){c.story_item("editable")&&c.story_item("edit")})},edit:function(b){var c=this,d=this.story_item("newItem")?"Add":"Edit";a("<fieldset/>").append(a('<label for="image_url">Image URL: </label>')).append(a('<input class="image_url_input" type="text" size="50"/>').val(b.text)).dialog({title:d,modal:!0,width:600,buttons:{Done:function(){c.story_item("save",a(this).find("input").val()),a(this).dialog("close")},Cancel:function(){a(this).dialog("close")}}})}}}(jQuery),function(a){wikimate.plugins.unknown={emit:function(a,b){return a.addClass("unknown").text("Unexpected item: "+JSON.stringify({type:b.type,text:b.text}))},bind:function(a,b){},edit:function(a){return!1}}}(jQuery),function(a){wikimate.plugins.one_column_layout={title:"One Column Layout",defaultData:function(){return{text:"Heading",story:[]}},emit:function(b,c){var d=a("<div/>").addClass("wikimate-layout-panel").story(c.story),e=a("<h2/>").addClass("wikimate-layout-heading").text(c.text),f=a('<div title="Add new Item">[+]</a>').addClass("add-new-factory");return b.html(e).append(d).append(f)},bind:function(b,c){var d=this,e=b.find("> .wikimate-layout-panel").on(wikimate.events.CHANGE,function(b,c){var e=a(this);d.story_item("data").story=e.story("data")});b.find("> .wikimate-layout-heading").wikimate_inline_editable({width:"98%",saved:function(a){d.story_item("update",{text:a})}}),b.find("> .add-new-factory").on("click",function(a){return e.story("newItem",{type:"factory"})})},edit:function(a){return this.find("> .item-content > .wikimate-layout-heading").dblclick(),this}}}(jQuery);